---
title: "taux croissance"
author: "FD"
output: 
  html_document:
    self_contained: false
---

This code produces a version of Oliver Johnson's case ratio figures for French data  
<https://twitter.com/BristOliver/status/1462112681956200458?s=20>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
```

# Initializations

```{r}
dlData <- FALSE
```

```{r}
library("RColorBrewer")

colJ <- brewer.pal(n = 7, name = "Set1")
names(colJ) <- 1:7
```

```{r}
source("usefulFunctions.R")
```


```{r}
# Function to make color transparent
makeTransparent = function(color, alpha = 0.5) {
  if(alpha<0 | alpha>1) stop("alpha must be between 0 and 1")
  newcol <- col2rgb(col=color, alpha = FALSE)
  return(rgb(red = newcol[1], green = newcol[2], blue = newcol[3], alpha = 255*alpha, maxColorValue=255))
}
```

# Load data

Source: <https://www.data.gouv.fr/fr/datasets/donnees-relatives-aux-resultats-des-tests-virologiques-covid-19/#>, `sp-pos-quot-fra-xxx.csv`

```{r}
URL <- "https://www.data.gouv.fr/fr/datasets/r/dd0de5d9-b5a5-4503-930a-7b08dc0adc7c"

dataFile <- paste0("data/FranceCas.csv") # name file with today's date
if(dlData){
  download.file(URL, dataFile) # download file
}

dat.France <- read.csv(dataFile, sep = ";", stringsAsFactors = FALSE)


head(dat.France)
unique(dat.France$cl_age90)
```

Add info on dates

```{r}
# Add weekday
weekday <- format(as.Date(dat.France$jour), "%w")
# Sunday is 0, set it as 7
weekday[weekday == 0] <- 7
dat.France$weekday <- weekday

# Add week number
weeknb <-  format(as.Date(dat.France$jour), "%W")
# Set 00 and 52 equal
weeknb[weeknb == "00"] <- "52"
dat.France$weeknb <- weeknb
```

Load and assign jours feries
Source: <https://www.data.gouv.fr/en/datasets/jours-feries-en-france/>

```{r}
feries <- read.csv("data/jours_feries_metropole.csv")
head(feries)

dat.France$ferie <- is.element(dat.France$jour, feries$date)
```


# Compute rates

```{r figOliverJohnson, fig.height = 6, fig.width = 10.66}
# Doubling time: ln(2) / growthrate, 
# where growth rate is ln(Nt - N0) / t
t2 <- log(2)/2
t4 <- log(2)/4
t1 <- log(2)/1
t05 <- log(2)/(5/7)
t10 <- log(2)/(10/7)

agecl <- 0
dateMin <- "2021-06-15" # min(dat.France$jour)
dateMax <- max(dat.France$jour)


plotRatio <- function(agecl, dateMin, dateMax){
  # Subset of the data for this age class and date range
  subdat <- dat.France[which(dat.France$jour >= dateMin & dat.France$jour <= dateMax & dat.France$cl_age90 == agecl), ]
  
  # Remove jours feries to avoid issues
  # (TODO: correction script)
  subdat[subdat$ferie, c("P", "T")] <- NA
  
  head(subdat)
  
  # Check that we have data for consecutive dates
  stopifnot(all(diff(as.Date(subdat$jour)) == 1))
  # When it's OK we can just go on
  
  # Index of the final line
  nend <- nrow(subdat)
  
  subdat$ratios7 <- NA # Initialize column
  
  # Ratios
  subdat[8:nend, "ratios7"] <- subdat[8:nend, "P"] / subdat[1:(nend - 7), "P"]
  # Logs (not needed because we will plot on a log scale)
  subdat$logratios7 <- log(subdat$ratios7)
  
  # Sliding average
  subdat$ratios7.slidingave <- sliding.window(subdat$ratios7)
  
  # Number of tests
  subdat[8:nend, "Tratios7"] <- subdat[8:nend, "T"] / subdat[1:(nend - 7), "T"]
  # Sliding average
  subdat$Tratios7.slidingave <- sliding.window(subdat$Tratios7)
  
  # Get max value
  xr <- max(abs(subdat$logratios7), na.rm = TRUE)
  
#  plot(as.Date(subdat$jour), subdat$logratios7, col = colJ[as.character(subdat$weekday)], pch = 16, ylim = 1.1*c(-xr, xr))
  
  colCroiss <- "#FF0000"
  colDecroiss <- "#00A5A5"
  
  xrr <- max(abs(subdat$ratios7), na.rm = TRUE) # Not used
  
  par(mgp = c(2.5, 0.5, 0.5), las = 1, 
      mar = c(3, 10, 2, 10), 
      cex = 1)
  ylm <- c(0.5, 1.1*exp(xr)) # ylim

  # Initialize figure
  plot(as.Date(subdat$jour), subdat$ratios7, ylim = ylm, log = "y", axes = FALSE, 
       xlab = "", ylab = "cas(j)/cas(j-7), échelle log", 
       type = "n")
  
  limPlot <- par("usr") # limits of the plot in user coordinates
  op <- 0.25 # Opacity parameter
  
  # Add Shading
  # Decroissance
  polygon(x = as.Date(c(limPlot[1], limPlot[2], limPlot[2], limPlot[1], limPlot[1]), origin = "1970-01-01"), 
          y = c(1, 1, ylm[1], ylm[1], 1), border = NA, col = makeTransparent(colDecroiss, op))
  # Croissance
  polygon(x = as.Date(c(limPlot[1], limPlot[2], limPlot[2], limPlot[1], limPlot[1]), origin = "1970-01-01"), 
          y = c(1, 1, ylm[2], ylm[2], 1), border = NA, col = makeTransparent(colCroiss, op))
  
  # Add horizontal lines for doubling times
  abline(h = 1, lwd = 2)
  colline <- "white" # Line color
  lwdd <- 1.5 # Line width
  
  abline(h = exp(t2), col = colline, lwd = lwdd)
  abline(h = exp(t4), col = colline, lwd = lwdd)
  abline(h = exp(t1), col = colline, lwd = lwdd)
  abline(h = exp(t05), col = colline, lwd = lwdd)
  abline(h = exp(t10), col = colline, lwd = lwdd)
  
  abline(h = exp(-t2), col = colline, lwd = lwdd)
  abline(h = exp(-t4), col = colline, lwd = lwdd)
  abline(h = exp(-t1), col = colline, lwd = lwdd)
  abline(h = exp(-t10), col = colline, lwd = lwdd)
  
  # Add mention direction in shaded areas
  text(as.Date((limPlot[1]+limPlot[2])/2, origin = "1970-01-01"), ylm[1], adj = c(0.5, -1), labels = "   Le nombre de cas décroît", col = colDecroiss, font = 2)
  text(as.Date((limPlot[1]+limPlot[2])/2, origin = "1970-01-01"), ylm[2], adj = c(0.5, 2), labels = "   Le nombre de cas croît", col = colCroiss, font = 2)
  
  # Add axes
  tckk <- -0.015
  cexx <- 0.75
  days <- seq(as.Date(dateMin), as.Date(dateMax)+30, by = "day")
  
  dateFormat <- "%d/%m"
  
  axis(1, at = as.Date(range(days)), labels = rep("", 2), tck = 0, pos = ylm[1])
  axis(1, at = seq(as.Date(dateMin), as.Date(dateMax)+14, by = "month"), labels = format(seq(as.Date(dateMin), as.Date(dateMax)+14, by = "month"), format = dateFormat), las = 3, cex.axis = cexx, tck = tckk, lwd = 0, lwd.ticks = 1, pos = ylm[1])
  
  axis(1, at = seq(as.Date(dateMin)+16, as.Date(dateMax)+14, by = "month"), labels = format(seq(as.Date(dateMin)+16, as.Date(dateMax)+14, by = "month"), format = dateFormat), las = 3, cex.axis = cexx, tck = tckk, lwd = 0, lwd.ticks = 1, pos = ylm[1])
  
  axis(1, at = days, labels = rep("", length(days)), las = 3, cex.axis = cexx, tck = tckk/2, lwd = 0, lwd.ticks = 1, pos = ylm[1])
  
  axis(2, at = c(seq(0.5, 1, by = 0.1), seq(1.2, 3, by = 0.2)), tck = -.01, pos = as.Date(limPlot[1], origin = "1970-01-01"))
  
  # Add side legend
  par(xpd = TRUE)
  cexleg <- 1
  dj <- 2
  text(x = as.Date(limPlot[2], origin = "1970-01-01") + dj, y = exp(t4), labels = "x2 toutes les 4 semaines", adj = c(0, 0.5), cex = cexleg)
  
  text(x = as.Date(limPlot[2], origin = "1970-01-01") + dj, y = exp(t2), labels = "x2 toutes les 2 semaines", adj = c(0, 0.5), cex = cexleg)
  
  text(x = as.Date(limPlot[2], origin = "1970-01-01") + dj, y = exp(t1), labels = "x2 toutes les semaines", adj = c(0, 0.5), cex = cexleg)
  
  text(x = as.Date(limPlot[2], origin = "1970-01-01") + dj, y = exp(t10), labels = "x2 tous les 10 jours", adj = c(0, 0.5), cex = cexleg)

  text(x = as.Date(limPlot[2], origin = "1970-01-01") + dj, y = exp(t05), labels = "x2 tous les 5 jours", adj = c(0, 0.5), cex = cexleg)
  
  text(x = as.Date(limPlot[2], origin = "1970-01-01") + dj, y = exp(-t4), labels = "÷2 toutes les 4 semaines", adj = c(0, 0.5), cex = cexleg)
  
  text(x = as.Date(limPlot[2], origin = "1970-01-01") + dj, y = exp(-t2), labels = "÷2 toutes les 2 semaines", adj = c(0, 0.5), cex = cexleg)
  
  text(x = as.Date(limPlot[2], origin = "1970-01-01") + dj, y = exp(-t10), labels = "÷2 tous les 10 jours", adj = c(0, 0.5), cex = cexleg)

  text(x = as.Date(limPlot[2], origin = "1970-01-01") + dj, y = exp(-t1), labels = "÷2 toutes les semaines", adj = c(0, 0.5), cex = cexleg)
  
  par(xpd = FALSE)
  points(as.Date(subdat$jour), subdat$ratios7, col = gray(0.3), pch = 16)
  
  lines(as.Date(subdat$jour), subdat$ratios7.slidingave)
  
  # Add tests
#  points(as.Date(subdat$jour), subdat$Tratios7, col = gray(0.8), pch = 16)
  
  
  mtext("Inspiré des figures de @BristOliver 
Données: https://www.data.gouv.fr/fr/datasets/donnees-relatives-aux-resultats-des-tests-virologiques-covid-19/# (en date de prélèvement)
Code: https://github.com/flodebarre/covid_indicateurs/blob/main/tauxCroissance.Rmd", side = 1, line = 2., adj = 0, cex = 0.5, family = "mono")
  
  mtext(paste0("Ratio du nombre de cas détectés d'une semaine à l'autre
(en date de prélèvement), jusqu'au ", format(as.Date(dateMax), format = "%d/%m")), font = 1, cex = 1.2, line = -0.75)
  
}


plotRatio(agecl, "2021-06-01", dateMax)
plotRatio(agecl, "2020-05-01", dateMax)
```


```{r, eval = FALSE}
plot(as.Date(subdat$jour), subdat$P, col = subdat$weekday)

subdat[which(subdat$logratios7 == max(subdat$logratios7, na.rm = TRUE)), ]

plot(as.Date(subdat$jour), subdat$T, col = subdat$weekday)

subdat[which(abs(subdat$logratios7)>1), ]

subdat[subdat$T == max(subdat$T), ]
```

