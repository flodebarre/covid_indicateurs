---
title: "Indicateurs"
author: "FD"
date: "`r format(Sys.Date(), '%d-%B-%Y')`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(global.par = TRUE)
```


```{r}
today <- Sys.Date() # today's date
```

```{r}
# Whether to generate a gif
doGif <- TRUE
lang <- "EN" #"FR" 
```


Mise à jour du `r today`.   
Source des données : <https://www.data.gouv.fr/fr/datasets/synthese-des-indicateurs-de-suivi-de-lepidemie-covid-19/>

# Generic functions and parameters

```{r}
# Function to compute a sliding window 
sliding.window <- function(v, winwdt = 7, pos = 4, na.rm = TRUE){
  # v vector to be averaged/summed
  # winwdt width of the window 
  # pos position of the focal day in the window
  # FUN function to apply
  n <- length(v)
  # Initialize output vector
  out <- 0 * v + (-1)
  out[1:(pos-1)] <- NA
  out[(n + 1 - winwdt + pos) : n] <- NA
  
  for(i in pos : (n - winwdt + pos)){
    out[i] <- mean(v[(i - pos + 1):(i + winwdt - pos)], na.rm = na.rm)
  }
  return(out[1:n])
}
```

# Load and clean data

```{r}
URL <- "https://www.data.gouv.fr/fr/datasets/r/f335f9ea-86e3-4ffa-9684-93c009d5e617"
dataFile <- paste0("data/FranceIndic_", today, ".csv") # name file with today's date
download.file(URL, dataFile) # download file from repo
dat.France <- read.csv(dataFile, sep = ",", stringsAsFactors = FALSE)
```

Remove leading NAs
```{r}
ibegin <- which(!is.na(dat.France$hosp | !is.na(dat.France$rea)))[1]
dat.France <- dat.France[-(1:ibegin), ]
```

Compute sliding window average
```{r}
dat.France$incid_hosp_ave7 <- sliding.window(dat.France$incid_hosp)
```

Transform dates as decimals
```{r}
year <- substr(dat.France$date, 1, 4) # Extract year
nbdays <- rep(365, nrow(dat.France)) # Number of days in the year
nbdays[year == "2020"] <- 366 # 2020 is leap year

dat.France$fracYear <- as.numeric(base::as.Date(dat.France$date) - base::as.Date(paste0(year, "-01-01"))) / nbdays # Fraction of the year
```


```{r eval = FALSE}
# Just for console evaluation
head(dat.France)
```

```{r}
# Polar coordinates: r, theta
# x = r * cos(theta)
# y = r * sin(theta)

frac2angle <- function(frac){
  # Transform fraction of year into an angle in radian
  - frac * 2 * pi + pi/2
}
polar2xy <- function(r, frac){
  maxval <- max(abs(r), na.rm = TRUE) # Get max value to center the plot
  theta <- frac2angle(frac) # angle value in radian, rotate clockwise
  
  # Polar to cartesian coordinates
  x <- r * cos(theta)
  y <- r * sin(theta)

  list(x = x, y = y, maxval = maxval)  
}

col2020 <- "#0072B2"
col2021 <- "#D55E00"
cols <- rep(col2020, nrow(dat.France))
cols[year == "2021"] <- col2021
makeTransparent<-function(someColor, alpha = 100){
  # Source : https://stackoverflow.com/questions/8047668/transparent-equivalent-of-given-color
  newColor <- col2rgb(someColor)
  apply(newColor, 2, function(curcoldata){rgb(red = curcoldata[1], 
                                              green = curcoldata[2],
                                              blue = curcoldata[3], 
                                              alpha = alpha, 
                                              maxColorValue = 255)})
}
colsTrp <- makeTransparent(cols, 70)
```

```{r}
addLegendPlot <- function(iend, graduations1, graduations2, r, dfinal, valfinal){
  # graduations1 main graduations for number in concentric circles
  # graduations2 sub graduations
  # r radius of months / time legend
  # dfinal fraction of the last day
  # valfinal value on the last day
  
  gmax <- max(c(graduations1, graduations2))
  lwd.grad <- 1.2
  
  for(i in graduations1){
    cxy <- polar2xy(i, seq(0, 1, length.out = 100))
    lines(cxy$x, cxy$y, type = "l", col = "gray", lwd = lwd.grad)
  }
  for(i in graduations2){
    cxy <- polar2xy(i, seq(0, 1, length.out = 100))
    lines(cxy$x, cxy$y, type = "l", col = "gray", lty = 3, lwd = lwd.grad)
  }
  for(i in graduations1){
  text(x = 0, y = graduations1, labels = graduations1, col = "gray", cex = 0.7, adj = c(0.5, -0.2) )
  text(x = 0, y = -graduations1, labels = graduations1, col = "gray", cex = 0.7, adj = c(0.5, +1.2) )
  }
  
  
  # Add months legend
  if(lang == "FR"){
    months <- c("Jan", "Fev", "Mar", "Avr", "Mai", "Jun", "Jui", "Aou", "Sep", "Oct", "Nov", "Dec")
  }else{
    months <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")    
  }
  
  thetas <- (1:12)/12 - 0.5/12 # Angles of the months
  for(i in seq_along(months)){
    text(x = r * cos(frac2angle(thetas[i])), y = r * sin(frac2angle(thetas[i])), labels = months[i], srt = 90 - thetas[i]*360, col = gray(0.5))
  }
  
  # Add line to locate the current days
  
  # Line to show the date
  lines(c(0, gmax * cos(dfinal)), c(0, gmax * sin(dfinal)))
  # Text with the date
  text(x = r * cos(dfinal), y = r * sin(dfinal), labels = dat.France[iend, "date"], srt = 90 - dat.France[iend, "fracYear"]*360, adj = c(0.2, 0.5), cex = 0.75, col = "black", )
  
  text(x = 0, y = r, adj = c(0, 0), labels = " 2021", col = col2021)
  text(x = 0, y = r, adj = c(1, 0), labels = "2020 ", col = col2020)
  
  # Add circle to locate the value
    fxy <- polar2xy(valfinal, seq(0, 1, length.out = 100))
    lines(fxy$x, fxy$y, type = "l", col = "black", lty = 1.5, lwd = lwd.grad)
}
```

# Hospitalisations 

```{r}
pxy <- polar2xy(dat.France$hosp, dat.France$fracYear)
```

```{r}
plotHosp <- function(iend = nrow(dat.France)){
  
# Initalize plot
par(pty="s")
par(mar = rep(3.5, 4))
rg <- 1.1 * c(- pxy$maxval, pxy$maxval)
plot(0, 0, type = "n", xlim = rg, ylim = rg, 
     xlab = "", ylab = "", 
     asp = 1, 
     axes = FALSE
     )

par(xpd = TRUE)

graduations1 <- c(10000, 20000, 30000)
graduations2 <- c(graduations1 - 5000, 35000)
r <- 40000 # Radius of the month labels
dfinal <- frac2angle(dat.France[iend, "fracYear"]) # End day of the plot
valfinal <- dat.France[iend, "hosp"]

addLegendPlot(iend, graduations1, graduations2, r, dfinal, valfinal)


if(lang == "FR"){
  title(main = "COVID-19, patients hospitalisés", line = 2.5)
}else{
  title(main = "COVID-19, hospitalized patients", line = 2.5)
}


#text(x = 0, y = -r - 5000, labels = paste0("Source des données : ", URL, "
#Mise à jour : ", today, " | ", "@flodebarre"), adj = c(0.5, 1), cex = 0.75)

par(xpd = FALSE)


points(pxy$x[1:iend], pxy$y[1:iend], col = cols, pch = 16, cex = 0.5)

#legend(x = "topright", col = c(col2020, col2021), pch = 16, legend = c(expression("2020", col = "blue"), "2021"), cex = 0.8, pt.cex = 0.5, bty = "n")

if(lang == "FR"){
  mtext(side = 1, text = paste0("Source des données : ", URL, "
Mise à jour : ", today, " | ", "@flodebarre"), cex = 0.75, line = 2)
}else{
  mtext(side = 1, text = paste0("Data : ", URL, "
Date : ", today, " | ", "@flodebarre"), cex = 0.75, line = 2)
}

}
plotHosp()
```

```{r}
if(doGif){
  for(iend in 1:nrow(dat.France)){
    png(filename = paste0("pics/hosp_", sprintf("%04d", iend), ".png"), width = 700, height = 700, pointsize = 20)
    plotHosp(iend)
    dev.off()
  }
  
  # Convert into gif
  system("convert -quality 100% -delay 0.1 -loop 0 pics/hosp*.png pics/animationHosp.gif")
  
  # Convert into movie
  system("convert -quality 100% -delay 0.12 -loop 0 pics/hosp*.png pics/animationHosp.mp4")
  
  # Remove temporary files
  system("rm pics/hosp*.png")
}

# Just re-do the last one
iend <- nrow(dat.France)
png(filename = paste0("pics/hosp_", sprintf("%04d", iend), ".png"), width = 700, height = 700, pointsize = 20)
plotHosp(iend)
dev.off()
```

# Rea / soins intensifs

```{r}
pxy <- polar2xy(dat.France$rea, dat.France$fracYear)
```

```{r}
plotRea <- function(iend = nrow(dat.France)){
  
# Initalize plot
par(pty="s")
par(mar = rep(3.5, 4))
rg <- 1.1 * c(- pxy$maxval, pxy$maxval)
plot(0, 0, type = "n", xlim = rg, ylim = rg, 
     xlab = "", ylab = "", 
     asp = 1, 
     axes = FALSE
     )

par(xpd = TRUE)

graduations1 <- c(2000, 4000, 6000)
graduations2 <- c(graduations1 - 1000, 7000)
r <- 8000
dfinal <- frac2angle(dat.France[iend, "fracYear"]) # End day of the plot
valfinal <- dat.France[iend, "rea"]


addLegendPlot(iend, graduations1, graduations2, r, dfinal, valfinal)

if(lang == "FR"){
  title(main = "COVID-19, réanimation ou soins intensifs", line = 2.5)
}else{
  title(main = "COVID-19, intensive care", line = 2.5)
}

#text(x = 0, y = -r - 500, labels = paste0("Source des données : ", URL, "
#Mise à jour : ", today, " | ", "@flodebarre"), adj = c(0.5, 1), cex = 0.75)

par(xpd = FALSE)


points(pxy$x[1:iend], pxy$y[1:iend], col = cols, pch = 16, cex = 0.5)

#legend(x = "topright", col = c(col2020, col2021), pch = 16, legend = c(expression("2020", col = "blue"), "2021"), cex = 0.8, pt.cex = 0.5, bty = "n")

if(lang == "FR"){
  mtext(side = 1, text = paste0("Source des données : ", URL, "
Mise à jour : ", today, " | ", "@flodebarre"), cex = 0.75, line = 2)
}else{
  mtext(side = 1, text = paste0("Data : ", URL, "
Date : ", today, " | ", "@flodebarre"), cex = 0.75, line = 2)
}

}
plotRea()
```

```{r}
if(doGif){
  for(iend in 1:nrow(dat.France)){
    png(filename = paste0("pics/rea_", sprintf("%04d", iend), ".png"), width = 700, height = 700, pointsize = 20)
    plotRea(iend)
    dev.off()
  }

  # Convert into gif
  system("convert -quality 100% -delay 0.1 -loop 0 pics/rea*.png pics/animationRea.gif")
  
  # Convert into movie
  system("convert -quality 100% -delay 0.12 -loop 0 pics/rea*.png pics/animationRea.mp4")  
  
  # Remove temporary files
  system("rm pics/rea*.png")
}

# Just re-do the last one
iend <- nrow(dat.France)
png(filename = paste0("pics/rea_", sprintf("%04d", iend), ".png"), width = 700, height = 700, pointsize = 20)
plotRea(iend)
dev.off()
```


